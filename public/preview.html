<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Preview</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b1020;
        color: #e5e7eb;
      }
      .wrap {
        height: 100%;
        display: grid;
        place-items: center;
        padding: 12px;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: 0;
        border-radius: 10px;
        background: transparent;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <iframe id="pv" sandbox="allow-forms"></iframe>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script>
      (function () {
        const KEY = "preview-html";
        const CACHE = "submission";
        const FINAL = "final-submission";
        const iframe = document.getElementById("pv");

        let submission = localStorage.getItem(FINAL);

        if (submission) {
          // If there's a final submission, use it and clear the cache
          iframe.srcdoc = submission;
        } else {
          let rawHTML = localStorage.getItem(KEY);

          const safeHtml = DOMPurify.sanitize(
            rawHTML || "<!doctype html><title>No content</title>",
            {
              WHOLE_DOCUMENT: true,
              ADD_TAGS: ["style"],
              ADD_ATTR: ["style"],
            }
          );

          iframe.srcdoc = safeHtml;
          localStorage.setItem(FINAL, safeHtml);
        }

        // Clean up localStorage after loading
        localStorage.removeItem(KEY);
        localStorage.removeItem(CACHE);
      })();
    </script>
  </body>
</html>
